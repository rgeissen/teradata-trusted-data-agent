<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trusted Data Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@antv/g2plot@latest/dist/g2plot.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap');
        
        :root {
            --teradata-orange: #F15F22;
            --teradata-orange-dark: #D9501A;
            --dark-bg: #262626;
            --medium-bg: #333333;
            --light-text: #F0F0F0;
            --medium-text: #999999;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle, #4a4a4a, var(--dark-bg));
            color: var(--light-text);
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(51, 51, 51, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar styling */
        #chat-container::-webkit-scrollbar,
        .category-panel::-webkit-scrollbar,
        #status-window-content::-webkit-scrollbar,
        #session-list::-webkit-scrollbar,
        .table-container::-webkit-scrollbar,
        #prompt-editor-textarea::-webkit-scrollbar,
        #system-prompt-popup-text::-webkit-scrollbar,
        #chat-modal-log::-webkit-scrollbar {
            width: 6px; 
        }
        #chat-container::-webkit-scrollbar-track,
        .category-panel::-webkit-scrollbar-track,
        #status-window-content::-webkit-scrollbar-track,
        #session-list::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track,
        #prompt-editor-textarea::-webkit-scrollbar-track,
        #system-prompt-popup-text::-webkit-scrollbar-track,
        #chat-modal-log::-webkit-scrollbar-track {
            background: transparent; 
        }
        #chat-container::-webkit-scrollbar-thumb,
        .category-panel::-webkit-scrollbar-thumb,
        #status-window-content::-webkit-scrollbar-thumb,
        #session-list::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb,
        #prompt-editor-textarea::-webkit-scrollbar-thumb,
        #system-prompt-popup-text::-webkit-scrollbar-thumb,
        #chat-modal-log::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 3px; 
        }

        .message-bubble { 
            animation: fadeIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) both;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .header-title { font-family: 'Space Grotesk', sans-serif; }
        
        .category-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .category-panel.open {
            max-height: 15rem; 
            overflow-y: auto;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .category-tab.active {
            background-color: var(--teradata-orange);
            color: white;
        }

        details.resource-item > summary { list-style: none; cursor: pointer; }
        details.resource-item > summary::-webkit-details-marker { display: none; }
        details.resource-item .chevron { transition: transform 0.2s ease-in-out; }
        details.resource-item[open] > summary .chevron { transform: rotate(90deg); }

        details.resource-selected > summary {
            background-color: var(--teradata-orange-dark) !important;
            box-shadow: 0 0 12px 2px rgba(241, 95, 34, 0.3);
            border-left: 4px solid var(--teradata-orange);
        }

        .resource-tab.active {
            border-bottom: 2px solid var(--teradata-orange);
            color: var(--teradata-orange);
        }

        /* Modal transitions */
        #prompt-modal-overlay, #info-modal-overlay, #config-modal-overlay, #prompt-editor-overlay, #confirm-modal-overlay, #system-prompt-popup-overlay, #chat-modal-overlay { transition: opacity 0.3s ease-in-out; }
        #prompt-modal-content, #info-modal-content, #config-modal-content, #prompt-editor-content, #confirm-modal-content, #system-prompt-popup-content, #chat-modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        #prompt-modal-overlay.hidden, #info-modal-overlay.hidden, #config-modal-overlay.hidden, #prompt-editor-overlay.hidden, #confirm-modal-overlay.hidden, #system-prompt-popup-overlay.hidden, #chat-modal-overlay.hidden { pointer-events: none; opacity: 0; }
        #prompt-modal-overlay.hidden #prompt-modal-content,
        #info-modal-overlay.hidden #info-modal-content,
        #config-modal-overlay.hidden #config-modal-content,
        #prompt-editor-overlay.hidden #prompt-editor-content,
        #confirm-modal-overlay.hidden #confirm-modal-content,
        #system-prompt-popup-overlay.hidden #system-prompt-popup-content,
        #chat-modal-overlay.hidden #chat-modal-content { transform: scale(0.95); opacity: 0; }
        
        .status-step {
            transition: all 0.3s ease-in-out;
            border-left: 4px solid transparent;
        }
        .status-step.active {
            border-left-color: var(--teradata-orange);
            background-color: rgba(241, 95, 34, 0.1);
        }
        .status-step.completed {
            border-left-color: #10b981;
            opacity: 0.7;
        }
        .status-step.workaround {
            border-left-color: #facc15; /* yellow-400 */
            background-color: rgba(250, 204, 21, 0.1);
        }
        .status-step.error {
            border-left-color: #f87171; /* red-400 */
            background-color: rgba(248, 113, 113, 0.1);
        }

        .response-card {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .response-card.summary-card {
            background-color: transparent;
            border: none;
            padding: 0;
        }
        .sql-code-block {
            background-color: #1E1E1E;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            overflow: hidden;
        }
        .sql-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.875rem;
            color: #ccc;
        }
        .sql-code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
        }
        .sql-code-block code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            color: #d4d4d4;
            white-space: pre;
        }
        .copy-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .copy-button.copied {
            background-color: #10b981;
        }

        .table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 500px;
            overflow-y: auto;
        }
        .assistant-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .assistant-table th, .assistant-table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1rem;
            text-align: left;
            white-space: nowrap;
        }
        .assistant-table th {
            background-color: rgba(241, 95, 34, 0.2);
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .assistant-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Chart container styling */
        .chart-render-target {
            min-height: 400px;
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        #status-window, #session-history-panel {
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out;
            flex-shrink: 0;
            overflow: hidden;
        }
        #status-window.collapsed, #session-history-panel.collapsed {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            border-width: 0;
        }
        #status-window.collapsed > *, #session-history-panel.collapsed > * {
            opacity: 0;
            pointer-events: none;
        }
        #status-window > *, #session-history-panel > * {
             transition: opacity 0.2s ease-in-out;
        }
        
        .session-item.active {
            background-color: var(--teradata-orange-dark);
            box-shadow: 0 0 12px 2px rgba(241, 95, 34, 0.3);
            border-left: 4px solid var(--teradata-orange);
        }

        #tool-header {
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, border-bottom-width 0.4s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            max-height: 500px;
        }
        #tool-header.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-bottom-width: 0;
            opacity: 0;
        }

        .menu-item {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 50;
        }
        .dropdown-menu.open {
            display: block;
        }
        
        select:disabled, input:disabled, button:disabled, fieldset:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Connection status dot styling */
        @keyframes blink {
            50% { background-color: #facc15; box-shadow: 0 0 8px #facc15; } /* yellow-400 */
        }
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .connection-dot.disconnected {
            background-color: #ef4444; /* red-500 */
        }
        .connection-dot.connected {
            background-color: #10b981; /* green-500 */
            box-shadow: 0 0 8px #10b981;
        }
        .connection-dot.idle {
            background-color: #6b7280; /* gray-500 */
            box-shadow: none;
        }
        .connection-dot.busy {
            animation: blink 1s infinite;
        }

    </style>
</head>
<body class="flex h-screen flex-col">

    <nav class="w-full bg-black/30 backdrop-blur-md border-b border-white/10 px-4 py-2 flex items-center justify-between flex-shrink-0 z-40">
        <div class="flex items-center gap-x-4">
            <h1 class="header-title text-xl font-bold text-white">Trusted Data Agent</h1>
        </div>
        <div class="flex items-center gap-x-6">
            <div class="flex items-center gap-x-4 pr-4 border-r border-white/10">
                <div class="flex items-center gap-x-2" title="Database MCP Server Status">
                    <div id="teradata-status-dot" class="connection-dot disconnected"></div>
                    <span class="text-sm text-gray-300">Database</span>
                </div>
                <!-- --- MODIFIED: Repurposed for LLM Status --- -->
                <div class="flex items-center gap-x-2" title="LLM Status">
                    <div id="llm-status-dot" class="connection-dot disconnected"></div>
                    <span class="text-sm text-gray-300">LLM</span>
                </div>
            </div>
            
            <div class="flex items-center gap-x-1">
                <div class="menu-item">
                    <button id="chat-modal-button" class="px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-white/10 rounded-md transition-colors disabled:opacity-50" disabled>Chat</button>
                </div>
                <div class="menu-item">
                    <button id="config-menu-button" class="px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-white/10 rounded-md transition-colors">Config</button>
                </div>
                <div class="menu-item">
                    <button id="prompt-editor-button" class="px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-white/10 rounded-md transition-colors disabled:opacity-50" disabled>System Prompt</button>
                </div>
                <div class="menu-item">
                    <button id="window-menu-button" class="px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-white/10 rounded-md transition-colors">Window</button>
                    <div id="window-dropdown-menu" class="dropdown-menu mt-2 w-56 rounded-md shadow-lg glass-panel p-1">
                        <label class="flex items-center justify-between w-full px-3 py-2 text-sm text-gray-200 rounded-md hover:bg-white/10 cursor-pointer">
                            <span>History Panel</span>
                            <input type="checkbox" id="toggle-history-checkbox" class="h-4 w-4 rounded text-teradata-orange bg-gray-700 border-gray-600 focus:ring-teradata-orange">
                        </label>
                        <label class="flex items-center justify-between w-full px-3 py-2 text-sm text-gray-200 rounded-md hover:bg-white/10 cursor-pointer">
                            <span>Capabilities Panel</span>
                            <input type="checkbox" id="toggle-header-checkbox" class="h-4 w-4 rounded text-teradata-orange bg-gray-700 border-gray-600 focus:ring-teradata-orange">
                        </label>
                        <label class="flex items-center justify-between w-full px-3 py-2 text-sm text-gray-200 rounded-md hover:bg-white/10 cursor-pointer">
                            <span>Status Panel</span>
                            <input type="checkbox" id="toggle-status-checkbox" class="h-4 w-4 rounded text-teradata-orange bg-gray-700 border-gray-600 focus:ring-teradata-orange">
                        </label>
                    </div>
                </div>
                <div class="menu-item">
                    <button id="info-button" class="px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-white/10 rounded-md transition-colors">Info</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 min-h-0">
        <aside id="session-history-panel" class="w-1/4 max-w-xs h-full flex flex-col glass-panel rounded-r-2xl shadow-2xl border-r border-white/10 collapsed">
            <header class="p-4 border-b border-white/10 flex justify-between items-center flex-shrink-0">
                <h2 class="header-title text-lg font-bold text-white">History</h2>
                <button id="new-chat-button" type="button" title="Start New Chat" class="p-2 text-gray-300 hover:text-white transition-colors rounded-md hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                </button>
            </header>
            <div id="session-list" class="flex-1 p-2 overflow-y-auto space-y-2">
                </div>
        </aside>

        <div id="main-content" class="flex flex-col h-full flex-1 min-w-0 relative">
             <div id="top-buttons-container" class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-30 pointer-events-none">
                <button id="toggle-history-button" title="Toggle History Panel" class="p-2 rounded-full bg-gray-800/50 hover:bg-teradata-orange transition-colors pointer-events-auto">
                    <svg id="history-expand-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                    <svg id="history-collapse-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                    </svg>
                </button>
                 <button id="toggle-header-button" title="Toggle Capabilities Panel" class="p-2 rounded-full bg-gray-800/50 hover:bg-teradata-orange transition-colors pointer-events-auto">
                     <svg id="header-collapse-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                    </svg>
                    <svg id="header-expand-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <button id="toggle-status-button" title="Toggle Status Panel" class="p-2 rounded-full bg-gray-800/50 hover:bg-teradata-orange transition-colors pointer-events-auto">
                    <svg id="status-collapse-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                    </svg>
                     <svg id="status-expand-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <header id="tool-header" class="relative bg-[#262626] rounded-b-2xl shadow-2xl z-20 flex flex-col flex-shrink-0 border-b border-white/10 pt-16">
                <nav id="resource-tabs" class="flex justify-center items-center gap-x-4 p-3 border-b border-white/10">
                    <button class="resource-tab px-4 py-2 font-semibold text-sm text-gray-300 transition-colors hover:text-white active" data-type="tools">Tools</button>
                    <button class="resource-tab px-4 py-2 font-semibold text-sm text-gray-300 transition-colors hover:text-white" data-type="prompts">Prompts</button>
                    <button class="resource-tab px-4 py-2 font-semibold text-sm text-gray-300 transition-colors hover:text-white" data-type="resources">Resources</button>
                </nav>
                <div id="panels-container" class="flex-1 min-h-0">
                    <div id="tools-panel" class="resource-panel flex flex-col h-full">
                        <nav id="tools-categories" class="flex justify-center items-center gap-x-2 p-3 border-b border-white/10"></nav>
                        <div id="tools-panels-container" class="flex-1 min-h-0 overflow-y-auto p-2"></div>
                    </div>
                    <div id="prompts-panel" class="resource-panel flex-col h-full" style="display: none;">
                        <nav id="prompts-categories" class="flex justify-center items-center gap-x-2 p-3 border-b border-white/10"></nav>
                        <div id="prompts-panels-container" class="flex-1 min-h-0 overflow-y-auto p-2"></div>
                    </div>
                    <div id="resources-panel" class="resource-panel flex-col h-full" style="display: none;">
                        <nav id="resources-categories" class="flex justify-center items-center gap-x-2 p-3 border-b border-white/10"></nav>
                        <div id="resources-panels-container" class="flex-1 min-h-0 overflow-y-auto p-2"></div>
                    </div>
                </div>
            </header>

            <div class="flex-1 flex flex-col min-h-0">
                 <main id="chat-container" class="flex-1 overflow-y-auto p-6">
                    <div id="chat-log" class="max-w-4xl mx-auto space-y-8"></div>
                </main>

                <footer class="p-4">
                    <div class="max-w-4xl mx-auto">
                        <form id="chat-form" class="flex items-center gap-3 glass-panel rounded-xl p-2">
                            <input type="text" id="user-input" placeholder="Please configure the application first..."
                                class="flex-1 p-3 bg-transparent border-none rounded-lg focus:outline-none text-white placeholder-gray-400"
                                autocomplete="off" disabled />
                            <button type="submit" id="submit-button"
                                class="p-3 bg-[#F15F22] rounded-lg hover:bg-[#D9501A] disabled:bg-gray-600 flex items-center justify-center w-12 h-12 transition-all duration-200 transform hover:scale-110"
                                disabled>
                                <svg id="send-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                <svg id="loading-spinner" class="w-6 h-6 text-white animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                        </form>
                    </div>
                </footer>
            </div>
        </div>

        <aside id="status-window" class="w-1/3 max-w-md h-full flex flex-col glass-panel rounded-l-2xl shadow-2xl border-l border-white/10">
            <header class="p-4 border-b border-white/10 flex flex-col justify-center items-center">
                <h2 id="status-title" class="header-title text-lg font-bold text-white">Live Status</h2>
                <div id="status-prompt-name" class="text-xs text-gray-400 mt-1 flex items-center justify-center gap-x-2 h-4">
                    <span id="prompt-name-display">No Model/Prompt Loaded</span>
                    <span id="thinking-indicator" class="hidden items-center gap-x-1 text-yellow-400">
                        <svg class="w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>LLM Thinking...</span>
                    </span>
                </div>
                <div id="token-usage-display" class="text-xs text-gray-400 mt-2 w-full">
                    <div id="token-normal-display">
                        <div class="flex justify-around items-center space-x-2">
                            <div class="text-center">
                                <span class="font-semibold text-gray-300">Last Statement</span>
                                <div class="flex gap-x-2 justify-center">
                                    <span title="Input Tokens">In: <strong id="statement-input-tokens" class="text-white">0</strong></span>
                                    <span title="Output Tokens">Out: <strong id="statement-output-tokens" class="text-white">0</strong></span>
                                </div>
                            </div>
                            <div class="border-l border-white/20 h-6"></div>
                            <div class="text-center">
                                <span class="font-semibold text-gray-300">Session Total</span>
                                <div class="flex gap-x-2 justify-center">
                                    <span title="Total Input Tokens">In: <strong id="total-input-tokens" class="text-white">0</strong></span>
                                    <span title="Total Output Tokens">Out: <strong id="total-output-tokens" class="text-white">0</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="token-aws-message" class="text-center hidden">Token usage not available for Amazon Bedrock</div>
                </div>
            </header>
            <div id="status-window-content" class="flex-1 p-4 overflow-y-auto space-y-4">
                <p class="text-gray-400">Waiting for a new request...</p>
            </div>
        </aside>
    </div>

    <div id="chat-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="chat-modal-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-2xl p-6 transform scale-95 opacity-0 flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold header-title">Direct Chat with Model</h3>
                <button type="button" id="chat-modal-close" class="p-2 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="chat-modal-log" class="flex-1 w-full p-3 bg-gray-800/80 border border-gray-600 rounded-md overflow-y-auto space-y-4">
            </div>
            <form id="chat-modal-form" class="mt-4 flex items-center gap-3">
                <input type="text" id="chat-modal-input" placeholder="Send a message..."
                    class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teradata-orange text-white placeholder-gray-400"
                    autocomplete="off" />
                <button type="submit" id="chat-modal-submit"
                    class="p-3 bg-teradata-orange rounded-lg hover:bg-teradata-orange-dark flex items-center justify-center w-12 h-12 transition-colors">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <div id="info-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="info-modal-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-lg p-6 transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mb-4 header-title">About This Project</h3>
            <div class="text-gray-300 space-y-4 text-sm">
                <div>
                    <h4 class="font-semibold text-white mb-1">Overview</h4>
                    <p>This Trusted Data Agent is a project designed to showcase AI-powered interaction with a Teradata database. It's initial goal was (and still is) to act as the perfect study buddy for LLM/MCP interaction as it outlines clear conversation transparency on all interactions between the consumer, the MCP server, and the LLM.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-1">Source Code & Contributions</h4>
                    <p>The Trusted Data Agent is open source and contributions are welcome. Please visit the main git project to report issues or submit pull requests.</p>
                    <p class="mt-2"><strong>Git Repository:</strong> <a href="https://github.com/rgeissen/teradata-trusted-data-agent.git" target="_blank" class="text-teradata-orange hover:underline">https://github.com/rgeissen/teradata-trusted-data-agent.git</a></p>
                </div>
                <hr class="border-white/10 my-4">
                <div>
                    <p class="text-xs text-gray-400">Trusted Data Agent Author/Initiator</p>
                    <p class="font-semibold text-white">Rainer Geissendoerfer, World Wide Data Architecture, Teradata</p>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="info-modal-close" class="px-4 py-2 rounded-md bg-teradata-orange hover:bg-teradata-orange-dark transition-colors font-semibold">Close</button>
            </div>
        </div>
    </div>

    <div id="config-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="config-modal-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-2xl p-8 transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold header-title text-white">Application Configuration</h3>
                <button type="button" id="config-modal-close" class="p-2 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="bg-white/5 border border-white/10 rounded-lg p-6 flex flex-col">
                <div class="flex-grow">
                    <div class="flex items-center mb-4">
                        <div class="bg-teradata-orange/20 text-teradata-orange rounded-lg p-2 mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        </div>
                        <h4 class="font-bold text-lg text-white">Core Services</h4>
                    </div>
                    <p class="text-sm text-gray-400 mb-6">Connect to the Teradata MCP Server and configure the Language Model. This is required for basic functionality.</p>
                    <form id="config-form" class="space-y-4">
                        <div>
                            <label for="mcp-host" class="block text-sm font-medium text-gray-300 mb-1">MCP Host</label>
                            <input type="text" id="mcp-host" name="host" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                        </div>
                        <div>
                            <label for="mcp-port" class="block text-sm font-medium text-gray-300 mb-1">MCP Port</label>
                            <input type="text" id="mcp-port" name="port" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                        </div>
                        <div>
                            <label for="mcp-path" class="block text-sm font-medium text-gray-300 mb-1">MCP Path</label>
                            <input type="text" id="mcp-path" name="path" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                        </div>
                        <div class="border-t border-white/10 my-4"></div>
                        <div>
                            <label for="llm-provider" class="block text-sm font-medium text-gray-300 mb-1">LLM Provider</label>
                            <select id="llm-provider" name="provider" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                                <option value="Google">Google</option>
                                <option value="Anthropic">Anthropic</option>
                                <option value="Amazon">Amazon</option>
                                <option value="Ollama">Ollama (Local)</option>
                                <option value="OpenAI" disabled>OpenAI (coming soon)</option>
                                <option value="Cohere" disabled>Cohere (coming soon)</option>
                                <option value="Mistral" disabled>Mistral (coming soon)</option>
                            </select>
                        </div>
                        
                        <div id="api-key-container">
                            <label for="llm-api-key" class="block text-sm font-medium text-gray-300 mb-1">LLM API Key</label>
                            <input type="password" id="llm-api-key" name="apiKey" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none" placeholder="Enter your API Key">
                        </div>

                        <div id="ollama-host-container" class="hidden">
                            <label for="ollama-host" class="block text-sm font-medium text-gray-300 mb-1">Ollama Host</label>
                            <input type="text" id="ollama-host" name="ollama_host" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none" placeholder="e.g., http://localhost:11434">
                        </div>

                        <div id="aws-credentials-container" class="hidden space-y-4">
                            <div>
                                <label for="aws-access-key-id" class="block text-sm font-medium text-gray-300 mb-1">AWS Access Key ID</label>
                                <input type="password" id="aws-access-key-id" name="aws_access_key_id" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none" placeholder="Enter your AWS Access Key ID">
                            </div>
                            <div>
                                <label for="aws-secret-access-key" class="block text-sm font-medium text-gray-300 mb-1">AWS Secret Access Key</label>
                                <input type="password" id="aws-secret-access-key" name="aws_secret_access_key" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none" placeholder="Enter your AWS Secret Access Key">
                            </div>
                            <div>
                                <label for="aws-region" class="block text-sm font-medium text-gray-300 mb-1">AWS Region</label>
                                <input type="text" id="aws-region" name="aws_region" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none" placeholder="e.g., us-east-1">
                            </div>
                        </div>

                        <div id="aws-listing-method-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Model Listing Method</label>
                            <div class="flex items-center gap-x-6">
                                <div class="flex items-center">
                                    <input id="foundation_models" name="listing_method" type="radio" value="foundation_models" class="h-4 w-4 border-gray-300 text-teradata-orange focus:ring-teradata-orange" checked>
                                    <label for="foundation_models" class="ml-3 block text-sm font-medium leading-6 text-gray-300">Foundation Models</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="inference_profiles" name="listing_method" type="radio" value="inference_profiles" class="h-4 w-4 border-gray-300 text-teradata-orange focus:ring-teradata-orange">
                                    <label for="inference_profiles" class="ml-3 block text-sm font-medium leading-6 text-gray-300">Inference Profiles</label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="llm-model" class="block text-sm font-medium text-gray-300 mb-1">LLM Model</label>
                            <div class="flex items-center gap-2">
                                <select id="llm-model" name="model" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                                    <option value="">-- Select Provider & Enter Credentials --</option>
                                </select>
                                <button type="button" id="refresh-models-button" title="Refresh Model List" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors">
                                    <svg id="refresh-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.985 5.356m0 0v4.992m0 0h4.992m0 0l3.181-3.183a8.25 8.25 0 0111.667 0l3.181 3.183" /></svg>
                                    <svg id="refresh-spinner" class="w-5 h-5 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t border-white/10 my-4"></div>
                        
                        <div id="charting-intensity-container">
                            <label for="charting-intensity" class="block text-sm font-medium text-gray-300 mb-1">Charting Intensity</label>
                            <select id="charting-intensity" name="charting_intensity" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none">
                                <option value="none">No Charting</option>
                                <option value="medium" selected>Medium Charting</option>
                                <option value="heavy">Heavy Charting</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="pt-6">
                    <button id="config-action-button" form="config-form" type="submit" class="w-full px-4 py-3 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors font-semibold flex items-center justify-center text-white">
                        <svg id="config-loading-spinner" class="w-5 h-5 mr-2 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span id="config-action-button-text">Connect & Load</span>
                    </button>
                </div>
            </div>
            <div id="config-status" class="text-sm min-h-[1.25rem] mt-6 text-center"></div>
        </div>
    </div>

    <div id="prompt-editor-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="prompt-editor-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-3xl p-6 transform scale-95 opacity-0 flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="prompt-editor-title" class="text-xl font-bold header-title">System Prompt Editor</h3>
                <div id="prompt-editor-status" class="text-sm"></div>
            </div>
            <textarea id="prompt-editor-textarea" class="flex-1 w-full p-3 bg-gray-800/80 border border-gray-600 rounded-md focus:ring-2 focus:ring-teradata-orange focus:border-teradata-orange outline-none font-mono text-sm"></textarea>
            <div class="flex justify-between items-center mt-4">
                <button type="button" id="prompt-editor-reset" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Reset to Default</button>
                <div>
                    <button type="button" id="prompt-editor-close" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors mr-2">Close</button>
                    <button type="button" id="prompt-editor-save" class="px-4 py-2 rounded-md bg-teradata-orange hover:bg-teradata-orange-dark transition-colors font-semibold">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="confirm-modal-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-lg p-6 transform scale-95 opacity-0">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirm Action</h3>
            <p id="confirm-modal-body" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-modal-cancel" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                <button type="button" id="confirm-modal-confirm" class="px-4 py-2 rounded-md bg-teradata-orange hover:bg-teradata-orange-dark transition-colors font-semibold">Confirm</button>
            </div>
        </div>
    </div>


    <div id="prompt-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="prompt-modal-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-lg p-6 transform scale-95 opacity-0">
            <h3 id="prompt-modal-title" class="text-xl font-bold mb-4"></h3>
            <form id="prompt-modal-form">
                <div id="prompt-modal-inputs" class="space-y-4 mb-6"></div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="prompt-modal-close" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-teradata-orange hover:bg-teradata-orange-dark transition-colors font-semibold">Run</button>
                </div>
            </form>
        </div>
    </div>

    <div id="system-prompt-popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden opacity-0">
        <div id="system-prompt-popup-content" class="glass-panel rounded-xl shadow-2xl w-full max-w-3xl p-6 transform scale-95 opacity-0 flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="system-prompt-popup-title" class="text-xl font-bold header-title">System Prompt Loaded</h3>
            </div>
            <div class="flex-1 w-full p-3 bg-gray-800/80 border border-gray-600 rounded-md overflow-y-auto">
                <pre id="system-prompt-popup-text" class="font-mono text-sm whitespace-pre-wrap"></pre>
            </div>
            <div class="flex justify-between items-center mt-4">
                 <div id="countdown-container" class="text-sm text-gray-400" style="visibility: hidden;">
                    Closing in <span id="countdown-timer" class="font-bold text-white">5</span>s...
                </div>
                <button type="button" id="system-prompt-popup-close" class="px-4 py-2 rounded-md bg-teradata-orange hover:bg-teradata-orange-dark transition-colors font-semibold">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- START: FULLY RESTORED AND ENHANCED JAVASCRIPT ---
        const chatLog = document.getElementById('chat-log');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const submitButton = document.getElementById('submit-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const newChatButton = document.getElementById('new-chat-button');
        
        const resourceTabs = document.getElementById('resource-tabs');
        
        const promptModalOverlay = document.getElementById('prompt-modal-overlay');
        const promptModalContent = document.getElementById('prompt-modal-content');
        const promptModalForm = document.getElementById('prompt-modal-form');
        const promptModalTitle = document.getElementById('prompt-modal-title');
        const promptModalInputs = document.getElementById('prompt-modal-inputs');
        const promptModalClose = document.getElementById('prompt-modal-close');

        const mainContent = document.getElementById('main-content');

        const statusWindow = document.getElementById('status-window');
        const statusWindowContent = document.getElementById('status-window-content');
        const toggleStatusButton = document.getElementById('toggle-status-button');
        const statusCollapseIcon = document.getElementById('status-collapse-icon');
        const statusExpandIcon = document.getElementById('status-expand-icon');
        const toggleStatusCheckbox = document.getElementById('toggle-status-checkbox');

        const sessionHistoryPanel = document.getElementById('session-history-panel');
        const sessionList = document.getElementById('session-list');
        const toggleHistoryButton = document.getElementById('toggle-history-button');
        const historyCollapseIcon = document.getElementById('history-collapse-icon');
        const historyExpandIcon = document.getElementById('history-expand-icon');
        const toggleHistoryCheckbox = document.getElementById('toggle-history-checkbox');

        const toolHeader = document.getElementById('tool-header');
        const toggleHeaderButton = document.getElementById('toggle-header-button');
        const headerCollapseIcon = document.getElementById('header-collapse-icon');
        const headerExpandIcon = document.getElementById('header-expand-icon');
        const toggleHeaderCheckbox = document.getElementById('toggle-header-checkbox');

        const infoButton = document.getElementById('info-button');
        const infoModalOverlay = document.getElementById('info-modal-overlay');
        const infoModalClose = document.getElementById('info-modal-close');
        const infoModalContent = document.getElementById('info-modal-content');

        const configMenuButton = document.getElementById('config-menu-button');
        const configModalOverlay = document.getElementById('config-modal-overlay');
        const configModalContent = document.getElementById('config-modal-content');
        const configModalClose = document.getElementById('config-modal-close');
        const configForm = document.getElementById('config-form');
        const configStatus = document.getElementById('config-status');
        const configLoadingSpinner = document.getElementById('config-loading-spinner');
        const configActionButton = document.getElementById('config-action-button');
        const configActionButtonText = document.getElementById('config-action-button-text');
        
        const refreshModelsButton = document.getElementById('refresh-models-button');
        const refreshIcon = document.getElementById('refresh-icon');
        const refreshSpinner = document.getElementById('refresh-spinner');
        const llmProviderSelect = document.getElementById('llm-provider');
        const llmModelSelect = document.getElementById('llm-model');
        const llmApiKeyInput = document.getElementById('llm-api-key');
        const apiKeyContainer = document.getElementById('api-key-container');
        const awsCredentialsContainer = document.getElementById('aws-credentials-container');
        const awsAccessKeyIdInput = document.getElementById('aws-access-key-id');
        const awsSecretAccessKeyInput = document.getElementById('aws-secret-access-key');
        const awsRegionInput = document.getElementById('aws-region');
        const awsListingMethodContainer = document.getElementById('aws-listing-method-container');
        const ollamaHostContainer = document.getElementById('ollama-host-container');
        const ollamaHostInput = document.getElementById('ollama-host');
        
        const chartingIntensitySelect = document.getElementById('charting-intensity');

        const teradataStatusDot = document.getElementById('teradata-status-dot');
        const llmStatusDot = document.getElementById('llm-status-dot');

        const windowMenuButton = document.getElementById('window-menu-button');
        const windowDropdownMenu = document.getElementById('window-dropdown-menu');
        
        const promptEditorButton = document.getElementById('prompt-editor-button');
        const promptEditorOverlay = document.getElementById('prompt-editor-overlay');
        const promptEditorContent = document.getElementById('prompt-editor-content');
        const promptEditorTitle = document.getElementById('prompt-editor-title');
        const promptEditorTextarea = document.getElementById('prompt-editor-textarea');
        const promptEditorSave = document.getElementById('prompt-editor-save');
        const promptEditorReset = document.getElementById('prompt-editor-reset');
        const promptEditorClose = document.getElementById('prompt-editor-close');
        const promptEditorStatus = document.getElementById('prompt-editor-status');
        
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmModalContent = document.getElementById('confirm-modal-content');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        
        const systemPromptPopupOverlay = document.getElementById('system-prompt-popup-overlay');
        const systemPromptPopupContent = document.getElementById('system-prompt-popup-content');
        const systemPromptPopupTitle = document.getElementById('system-prompt-popup-title');
        const systemPromptPopupText = document.getElementById('system-prompt-popup-text');
        const systemPromptPopupClose = document.getElementById('system-prompt-popup-close');

        const chatModalButton = document.getElementById('chat-modal-button');
        const chatModalOverlay = document.getElementById('chat-modal-overlay');
        const chatModalContent = document.getElementById('chat-modal-content');
        const chatModalClose = document.getElementById('chat-modal-close');
        const chatModalForm = document.getElementById('chat-modal-form');
        const chatModalInput = document.getElementById('chat-modal-input');
        const chatModalLog = document.getElementById('chat-modal-log');
        let simpleChatHistory = [];

        let currentProvider = 'Google';
        let currentModel = '';
        let currentStatusId = 0;
        let currentSessionId = null;
        let resourceData = { tools: {}, prompts: {}, resources: {}, charts: {} };
        let currentlySelectedResource = null;
        let eventSource = null;
        let systemPromptPopupTimer = null;
        let countdownValue = 5;
        let mouseMoveHandler = null;
        let pristineConfig = {};
        let isMouseOverStatus = false; 
        
        let defaultPromptsCache = {};

        const thinkingIndicator = document.getElementById('thinking-indicator');
        const promptNameDisplay = document.getElementById('prompt-name-display');

        statusWindowContent.addEventListener('mouseenter', () => { isMouseOverStatus = true; });
        statusWindowContent.addEventListener('mouseleave', () => { isMouseOverStatus = false; });
        
        function getSystemPrompts() {
            try {
                const prompts = localStorage.getItem('userSystemPrompts');
                return prompts ? JSON.parse(prompts) : {};
            } catch (e) {
                console.error("Could not parse system prompts from localStorage", e);
                return {};
            }
        }
        
        function getNormalizedModelId(modelId) {
            if (!modelId) return '';
            if (modelId.startsWith('arn:aws:bedrock:')) {
                const parts = modelId.split('/');
                const modelPart = parts[parts.length - 1];
                return modelPart.replace(/^(eu|us|apac)\./, '');
            }
            return modelId;
        }

        function getPromptStorageKey(provider, model) {
            const normalizedModel = getNormalizedModelId(model);
            return `${provider}-${normalizedModel}`;
        }

        function saveSystemPromptForModel(provider, model, promptText, isCustom) {
            const prompts = getSystemPrompts();
            const key = getPromptStorageKey(provider, model);
            prompts[key] = { prompt: promptText, isCustom: isCustom };
            localStorage.setItem('userSystemPrompts', JSON.stringify(prompts));
        }

        function getSystemPromptForModel(provider, model) {
            const prompts = getSystemPrompts();
            const key = getPromptStorageKey(provider, model);
            return prompts[key]?.prompt || null;
        }

        function isPromptCustomForModel(provider, model) {
            const prompts = getSystemPrompts();
            const key = getPromptStorageKey(provider, model);
            return prompts[key]?.isCustom || false;
        }

        async function getDefaultSystemPrompt(provider, model) {
            const key = getPromptStorageKey(provider, model);
            if (defaultPromptsCache[key]) {
                return defaultPromptsCache[key];
            }

            try {
                const res = await fetch(`/system_prompt/${provider}/${getNormalizedModelId(model)}`);
                if (!res.ok) {
                    throw new Error(`Failed to fetch default prompt: ${res.statusText}`);
                }
                const data = await res.json();
                if (data.system_prompt) {
                    defaultPromptsCache[key] = data.system_prompt;
                    return data.system_prompt;
                }
                throw new Error("Server response did not contain a system_prompt.");
            } catch (e) {
                console.error(`Error getting default system prompt for ${key}:`, e);
                promptEditorStatus.textContent = 'Error fetching default prompt.';
                promptEditorStatus.className = 'text-sm text-red-400';
                return null;
            }
        }


        function copyToClipboard(button) {
            const codeBlock = button.closest('.sql-code-block').querySelector('code');
            const textToCopy = codeBlock.innerText;
            
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 7a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H-.5A.5.5 0 0 1-1 7z"/></svg> Copy`;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea);
        }

        function renderChart(containerId, spec) {
            try {
                const chartSpec = typeof spec === 'string' ? JSON.parse(spec) : spec;
                const plot = new G2Plot[chartSpec.type](containerId, chartSpec.options);
                plot.render();
            } catch (e) {
                console.error("Failed to render chart:", e);
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<div class="p-4 text-red-400">Error rendering chart: ${e.message}</div>`;
                }
            }
        }

        function addMessage(role, content) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-bubble flex items-start gap-4 ${role === 'user' ? 'justify-end' : ''}`;
            const icon = document.createElement('div');
            icon.className = 'flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-lg';
            icon.textContent = role === 'user' ? 'U' : 'A';
            icon.classList.add(role === 'user' ? 'bg-gray-700' : 'bg-[#F15F22]');
            
            const messageContainer = document.createElement('div');
            messageContainer.className = 'p-4 rounded-xl shadow-lg max-w-2xl glass-panel';
            messageContainer.classList.add(role === 'user' ? 'bg-gray-800/50' : 'bg-[#333333]/50');

            const author = document.createElement('p');
            author.className = 'font-bold mb-2 text-sm';
            author.textContent = role === 'user' ? 'You' : 'Assistant';
            author.classList.add(role === 'user' ? 'text-gray-300' : 'text-[#F15F22]');
            messageContainer.appendChild(author);
            
            const messageContent = document.createElement('div');
            messageContent.innerHTML = content; 
            messageContainer.appendChild(messageContent);

            wrapper.appendChild(role === 'user' ? messageContainer : icon);
            wrapper.appendChild(role === 'user' ? icon : messageContainer);

            chatLog.appendChild(wrapper);
            
            const chartContainers = messageContent.querySelectorAll('.chart-render-target');
            chartContainers.forEach(container => {
                if (container.dataset.spec) {
                    renderChart(container.id, container.dataset.spec);
                }
            });

            wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function toggleLoading(isLoading) {
            userInput.disabled = isLoading;
            submitButton.disabled = isLoading;
            newChatButton.disabled = isLoading;
            sendIcon.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        function updateStatusWindow(eventData, isFinal = false) {
            const { step, details, type } = eventData;
            if (!step) {
                return;
            }

            const lastStep = document.getElementById(`status-step-${currentStatusId}`);
            if (lastStep) {
                lastStep.classList.remove('active');
                lastStep.classList.add('completed');
            }

            currentStatusId++;
            const stepEl = document.createElement('div');
            stepEl.id = `status-step-${currentStatusId}`;
            stepEl.className = 'status-step p-3 rounded-md';

            const stepTitle = document.createElement('h4');
            stepTitle.className = 'font-bold text-sm text-white mb-2';
            stepTitle.textContent = step;
            stepEl.appendChild(stepTitle);

            const metricsEl = document.createElement('div');
            metricsEl.className = 'per-call-metrics text-xs text-gray-400 mb-2 hidden';
            stepEl.appendChild(metricsEl);

            if (details) {
                const pre = document.createElement('pre');
                pre.className = 'p-2 bg-gray-900/70 rounded-md text-xs text-gray-300 overflow-x-auto whitespace-pre-wrap';
                try {
                    const parsed = typeof details === 'string' ? JSON.parse(details) : details;
                    pre.textContent = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    pre.textContent = details;
                }
                stepEl.appendChild(pre);
            }

            statusWindowContent.appendChild(stepEl);

            if (type === 'workaround') {
                stepEl.classList.add('workaround');
            } else if (type === 'error') {
                stepEl.classList.add('error');
            }

            if (!isFinal) {
                stepEl.classList.add('active');
            } else {
                stepEl.classList.add('completed');
            }

            if (!isMouseOverStatus) {
                statusWindowContent.scrollTop = statusWindowContent.scrollHeight;
            }
        }

        function updateTokenDisplay(data) {
            const normalDisplay = document.getElementById('token-normal-display');
            const awsMessage = document.getElementById('token-aws-message');

            if (currentProvider === 'Amazon') {
                normalDisplay.classList.add('hidden');
                awsMessage.classList.remove('hidden');
                return;
            }
            
            normalDisplay.classList.remove('hidden');
            awsMessage.classList.add('hidden');

            document.getElementById('statement-input-tokens').textContent = (data.statement_input || 0).toLocaleString();
            document.getElementById('statement-output-tokens').textContent = (data.statement_output || 0).toLocaleString();
            document.getElementById('total-input-tokens').textContent = (data.total_input || 0).toLocaleString();
            document.getElementById('total-output-tokens').textContent = (data.total_output || 0).toLocaleString();
        }

        function setThinkingIndicator(isThinking) {
            if (isThinking) {
                promptNameDisplay.classList.add('hidden');
                thinkingIndicator.classList.remove('hidden');
                thinkingIndicator.classList.add('flex');
                llmStatusDot.classList.add('busy');
                llmStatusDot.classList.remove('idle', 'connected');
            } else {
                thinkingIndicator.classList.add('hidden');
                thinkingIndicator.classList.remove('flex');
                promptNameDisplay.classList.remove('hidden');
                llmStatusDot.classList.remove('busy');
                llmStatusDot.classList.add('connected');
            }
        }

        function updateStatusPromptName() {
            const promptNameDiv = document.getElementById('prompt-name-display');
            if (currentProvider && currentModel) {
                const isCustom = isPromptCustomForModel(currentProvider, currentModel);
                const promptType = isCustom ? `Custom` : `Default`;
                promptNameDiv.innerHTML = `
                    <span class="font-semibold text-gray-300">${promptType} Prompt</span>
                    <span class="text-gray-500">/</span>
                    <span class="font-mono text-teradata-orange text-xs">${getNormalizedModelId(currentModel)}</span>
                `;
            } else {
                promptNameDiv.innerHTML = '<span>No Model/Prompt Loaded</span>';
            }
        }

        async function startStream(endpoint, body) {
            if (body.message) {
                addMessage('user', body.message);
            } else {
                addMessage('user', `Executing prompt: ${body.prompt_name}`);
            }
            userInput.value = '';
            toggleLoading(true);
            statusWindowContent.innerHTML = ''; 
            currentStatusId = 0;
            setThinkingIndicator(false); 

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const messages = buffer.split('\n\n');
                    buffer = messages.pop(); 

                    for (const message of messages) {
                        if (!message) continue;

                        let eventName = 'message';
                        let dataLine = '';

                        const lines = message.split('\n');
                        for(const line of lines) {
                            if (line.startsWith('data:')) {
                                dataLine = line.substring(5).trim();
                            } else if (line.startsWith('event:')) {
                                eventName = line.substring(6).trim();
                            }
                        }

                        if (dataLine) {
                            const eventData = JSON.parse(dataLine);
                            
                            if (eventName === 'message' && eventData.step === "Calling LLM") {
                                setThinkingIndicator(true);
                            }
                            
                            if (['llm_thought', 'tool_result', 'prompt_selected', 'final_answer', 'error'].includes(eventName)) {
                                setThinkingIndicator(false);
                            }

                            if (eventName === 'status_indicator_update') {
                                const { target, state } = eventData;
                                const dot = target === 'db' ? teradataStatusDot : llmStatusDot;
                                if (dot) {
                                    if (state === 'busy') {
                                        dot.classList.add('busy');
                                        dot.classList.remove('idle', 'connected', 'disconnected');
                                    } else { // idle
                                        dot.classList.remove('busy');
                                        if (target === 'db') {
                                            dot.classList.add('connected');
                                        } else {
                                            dot.classList.add('idle');
                                        }
                                    }
                                }
                            } else if (eventName === 'token_update') {
                                updateTokenDisplay(eventData);
                                const lastStep = document.getElementById(`status-step-${currentStatusId}`);
                                if (lastStep && currentProvider !== 'Amazon') {
                                    const metricsEl = lastStep.querySelector('.per-call-metrics');
                                    if (metricsEl) {
                                        metricsEl.innerHTML = `(LLM Call: ${eventData.statement_input.toLocaleString()} in / ${eventData.statement_output.toLocaleString()} out)`;
                                        metricsEl.classList.remove('hidden');
                                    }
                                }
                            } else if (eventName === 'request_user_input') {
                                updateStatusWindow({ step: "Action Required", details: "Waiting for user to correct parameters.", type: 'workaround' });
                                toggleLoading(false);
                                openCorrectionModal(eventData.details);
                            } else if (eventName === 'session_update') {
                                const { id, name } = eventData.session_name_update;
                                const sessionItem = document.getElementById(`session-${id}`);
                                if (sessionItem) {
                                    sessionItem.querySelector('span').textContent = name;
                                }
                            } else if (eventName === 'llm_thought') {
                                updateStatusWindow({ step: "Assistant's Thought Process", ...eventData });
                            } else if (eventName === 'prompt_selected') {
                                updateStatusWindow(eventData);
                                if (eventData.prompt_name) {
                                    highlightResource(eventData.prompt_name, 'prompts');
                                }
                            } else if (eventName === 'tool_result') {
                                updateStatusWindow(eventData);
                                if (eventData.tool_name) {
                                    const toolType = eventData.tool_name.startsWith('generate_') ? 'charts' : 'tools';
                                    highlightResource(eventData.tool_name, toolType);
                                }
                            } else if (eventName === 'final_answer') {
                                addMessage('assistant', eventData.final_answer);
                                updateStatusWindow({ step: "Finished", details: "Response sent to chat." }, true);
                                toggleLoading(false);
                            } else if (eventName === 'error') {
                                addMessage('assistant', `Sorry, an error occurred: ${eventData.error}`);
                                updateStatusWindow({ step: "Error", ...eventData, type: 'error' }, true);
                                toggleLoading(false);
                            } else {
                                updateStatusWindow(eventData);
                            }
                        }
                    }
                }

            } catch (error) {
                addMessage('assistant', `Sorry, a connection error occurred: ${error.message}`);
                updateStatusWindow({ step: "Error", details: error.stack, type: 'error' }, true);
            } finally {
                toggleLoading(false);
                setThinkingIndicator(false);
            }
        }

        function createResourceItem(resource, type) {
            const detailsEl = document.createElement('details');
            detailsEl.id = `resource-${type}-${resource.name}`;
            detailsEl.className = 'resource-item bg-gray-800/50 rounded-lg border border-gray-700/60';
            
            detailsEl.innerHTML = `
                <summary class="flex justify-between items-center p-3 font-semibold text-white hover:bg-gray-700/50 rounded-lg transition-colors">
                    <span>${resource.name}</span>
                    <svg class="chevron w-5 h-5 text-[#F15F22] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </summary>
                <div class="p-3 pt-2 text-sm text-gray-300 border-t border-gray-700/60">${resource.description}</div>
            `;
            
            if (type === 'prompts') {
                const summary = detailsEl.querySelector('summary');
                summary.addEventListener('click', (e) => {
                    e.preventDefault();
                    openPromptModal(resource);
                });
            }

            return detailsEl;
        }

        async function loadResources(type) {
            const tabButton = document.querySelector(`.resource-tab[data-type="${type}"]`);
            const categoriesContainer = document.getElementById(`${type}-categories`);
            const panelsContainer = document.getElementById(`${type}-panels-container`);
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);

            try {
                const res = await fetch(`/${type}`);
                const data = await res.json();

                if (!res.ok || data.error || Object.keys(data).length === 0) {
                    if(tabButton) tabButton.style.display = 'none';
                    return;
                }
                
                tabButton.style.display = 'inline-block';
                const totalCount = Object.values(data).reduce((acc, items) => acc + items.length, 0);
                tabButton.textContent = `${typeCapitalized} (${totalCount})`;

                resourceData[type] = data;
                categoriesContainer.innerHTML = '';
                panelsContainer.innerHTML = '';
                
                Object.keys(data).forEach(category => {
                    const categoryTab = document.createElement('button');
                    categoryTab.className = 'category-tab px-4 py-2 rounded-md font-semibold text-sm transition-colors hover:bg-[#D9501A]';
                    categoryTab.textContent = category;
                    categoryTab.dataset.category = category;
                    categoryTab.dataset.type = type;
                    categoriesContainer.appendChild(categoryTab);

                    const panel = document.createElement('div');
                    panel.id = `panel-${type}-${category}`;
                    panel.className = 'category-panel px-4 space-y-2';
                    panel.dataset.category = category;

                    data[category].forEach(resource => {
                        const itemEl = createResourceItem(resource, type);
                        panel.appendChild(itemEl);
                    });
                    panelsContainer.appendChild(panel);
                });

                document.querySelectorAll(`#${type}-categories .category-tab`).forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll(`#${type}-categories .category-tab`).forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        document.querySelectorAll(`#${type}-panels-container .category-panel`).forEach(p => {
                            p.classList.toggle('open', p.dataset.category === tab.dataset.category);
                        });
                    });
                });

                if (categoriesContainer.querySelector('.category-tab')) {
                    categoriesContainer.querySelector('.category-tab').click();
                }

            } catch (error) {
                console.error(`Failed to load ${type}: ${error.message}`);
                if(tabButton) {
                    tabButton.textContent = `${typeCapitalized} (Error)`;
                    tabButton.style.display = 'inline-block';
                }
                categoriesContainer.innerHTML = '';
                panelsContainer.innerHTML = `<div class="p-4 text-center text-red-400">Failed to load ${type}.</div>`;
            }
        }

        function highlightResource(resourceName, type) {
            if (currentlySelectedResource) {
                currentlySelectedResource.classList.remove('resource-selected');
            }

            let resourceCategory = null;
            for (const category in resourceData[type]) {
                if (resourceData[type][category].some(r => r.name === resourceName)) {
                    resourceCategory = category;
                    break;
                }
            }

            if (resourceCategory) {
                document.querySelector(`.resource-tab[data-type="${type}"]`).click();
                const categoryTab = document.querySelector(`.category-tab[data-type="${type}"][data-category="${resourceCategory}"]`);
                if(categoryTab) categoryTab.click();

                const resourceElement = document.getElementById(`resource-${type}-${resourceName}`);
                if (resourceElement) {
                    resourceElement.open = true;
                    resourceElement.classList.add('resource-selected');
                    currentlySelectedResource = resourceElement;
                    
                    setTimeout(() => {
                        resourceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 350);
                }
            }
        }

        async function startNewSession() {
            const activePrompt = getSystemPromptForModel(currentProvider, currentModel);
            if (!activePrompt) {
                addMessage('assistant', 'Cannot start a new session. The system prompt is not loaded for the current model. Please re-configure.');
                return;
            }
            chatLog.innerHTML = '';
            statusWindowContent.innerHTML = '<p class="text-gray-400">Waiting for a new request...</p>';
            updateTokenDisplay({ statement_input: 0, statement_output: 0, total_input: 0, total_output: 0 });
            addMessage('assistant', "Starting a new conversation... Please wait.");
            toggleLoading(true);
            setThinkingIndicator(false);
            try {
                const res = await fetch('/session', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        system_prompt: activePrompt,
                        charting_intensity: chartingIntensitySelect.value
                    })
                });
                const data = await res.json();
                if (res.ok && data.session_id) {
                    addSessionToList(data.session_id, data.name, true);
                    loadSession(data.session_id);
                } else {
                    throw new Error(data.error || "Failed to get a session ID.");
                }
            } catch (error) {
                addMessage('assistant', `Failed to start a new session: ${error.message}`);
            } finally {
                toggleLoading(false);
                userInput.focus();
            }
        }

        async function loadSession(sessionId) {
            if (currentSessionId === sessionId) return;

            toggleLoading(true);
            try {
                const res = await fetch(`/session/${sessionId}`);
                const data = await res.json();

                if (res.ok) {
                    currentSessionId = sessionId;
                    chatLog.innerHTML = '';
                    data.history.forEach(msg => addMessage(msg.role, msg.content));
                    updateTokenDisplay({ total_input: data.input_tokens, total_output: data.output_tokens });
                    
                    document.querySelectorAll('.session-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.sessionId === sessionId);
                    });
                    
                    if (data.history.length === 0) {
                         addMessage('assistant', "I'm ready to help. How can I assist you with your Teradata system today?");
                    }
                    updateStatusPromptName();
                } else {
                    addMessage('assistant', `Error loading session: ${data.error}`);
                }
            } catch (error) {
                addMessage('assistant', `Failed to load session: ${error.message}`);
            } finally {
                toggleLoading(false);
                userInput.focus();
            }
        }

        function addSessionToList(sessionId, name, isActive = false) {
            const sessionItem = document.createElement('button');
            sessionItem.id = `session-${sessionId}`;
            sessionItem.dataset.sessionId = sessionId;
            sessionItem.className = 'session-item w-full text-left p-3 rounded-lg hover:bg-white/10 transition-colors truncate';
            if (isActive) {
                document.querySelectorAll('.session-item').forEach(item => item.classList.remove('active'));
                sessionItem.classList.add('active');
            }
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-semibold text-sm text-white';
            nameSpan.textContent = name;
            sessionItem.appendChild(nameSpan);

            sessionItem.addEventListener('click', () => loadSession(sessionId));
            sessionList.prepend(sessionItem);
        }

        async function loadAllSessions() {
            try {
                const res = await fetch('/sessions');
                const sessions = await res.json();
                sessionList.innerHTML = '';
                if (sessions && sessions.length > 0) {
                    sessions.forEach(s => addSessionToList(s.id, s.name));
                    loadSession(sessions[0].id);
                } else {
                }
            } catch (e) {
                console.error("Could not load sessions", e);
                addMessage('assistant', 'Could not retrieve past sessions. Please configure the application to start.');
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message || !currentSessionId) return;
            startStream('/ask_stream', { message, session_id: currentSessionId });
        });

        newChatButton.addEventListener('click', startNewSession);

        resourceTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('resource-tab')) {
                const type = e.target.dataset.type;
                document.querySelectorAll('.resource-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');

                document.querySelectorAll('.resource-panel').forEach(panel => {
                    panel.style.display = panel.id === `${type}-panel` ? 'flex' : 'none';
                });
            }
        });

        function openPromptModal(prompt) {
            promptModalOverlay.classList.remove('hidden', 'opacity-0');
            promptModalContent.classList.remove('scale-95', 'opacity-0');
            promptModalTitle.textContent = prompt.name;
            promptModalForm.dataset.promptName = prompt.name;
            promptModalInputs.innerHTML = '';
            promptModalForm.querySelector('button[type="submit"]').textContent = 'Run Prompt';


            if (prompt.arguments && prompt.arguments.length > 0) {
                prompt.arguments.forEach(arg => {
                    const inputGroup = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = `prompt-arg-${arg.name}`;
                    label.className = 'block text-sm font-medium text-gray-300 mb-1';
                    label.textContent = arg.name + (arg.required ? ' *' : '');
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `prompt-arg-${arg.name}`;
                    input.name = arg.name;
                    input.className = 'w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-[#F15F22] focus:border-[#F15F22] outline-none';
                    input.placeholder = arg.description || `Enter value for ${arg.name}`;
                    if (arg.required) input.required = true;

                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    promptModalInputs.appendChild(inputGroup);
                });
            } else {
                promptModalInputs.innerHTML = '<p class="text-gray-400">This prompt requires no arguments.</p>';
            }

            promptModalForm.onsubmit = async (e) => {
                e.preventDefault();
                const promptName = e.target.dataset.promptName;
                const formData = new FormData(e.target);
                const arugments = Object.fromEntries(formData.entries());
                
                closePromptModal();
                await startStream('/invoke_prompt_stream', {
                    session_id: currentSessionId,
                    prompt_name: promptName,
                    arguments: arugments
                });
            };
        }

        function openCorrectionModal(data) {
            promptModalOverlay.classList.remove('hidden', 'opacity-0');
            promptModalContent.classList.remove('scale-95', 'opacity-0');
            
            const spec = data.specification;
            promptModalTitle.textContent = `Correction for: ${spec.name}`;
            promptModalForm.dataset.toolName = spec.name;
            promptModalInputs.innerHTML = '';
            promptModalForm.querySelector('button[type="submit"]').textContent = 'Run Correction';

            const messageEl = document.createElement('p');
            messageEl.className = 'text-yellow-300 text-sm mb-4 p-3 bg-yellow-500/10 rounded-lg';
            messageEl.textContent = data.message;
            promptModalInputs.appendChild(messageEl);

            spec.arguments.forEach(arg => {
                const inputGroup = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = `correction-arg-${arg.name}`;
                label.className = 'block text-sm font-medium text-gray-300 mb-1';
                label.textContent = arg.name + (arg.required ? ' *' : '');
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `correction-arg-${arg.name}`;
                input.name = arg.name;
                input.className = 'w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-[#F15F22] focus:border-[#F15F22] outline-none';
                input.placeholder = arg.description || `Enter value for ${arg.name}`;
                if (arg.required) input.required = true;

                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                promptModalInputs.appendChild(inputGroup);
            });

            promptModalForm.onsubmit = async (e) => {
                e.preventDefault();
                const toolName = e.target.dataset.toolName;
                const formData = new FormData(e.target);
                const userArgs = Object.fromEntries(formData.entries());

                const correctedPrompt = `Please run the tool '${toolName}' with the following corrected parameters: ${JSON.stringify(userArgs)}`;
                
                closePromptModal();
                
                startStream('/ask_stream', { message: correctedPrompt, session_id: currentSessionId });
            };
        }

        function closePromptModal() {
            promptModalOverlay.classList.add('opacity-0');
            promptModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => promptModalOverlay.classList.add('hidden'), 300);
        }

        promptModalClose.addEventListener('click', closePromptModal);
        promptModalOverlay.addEventListener('click', (e) => {
            if (e.target === promptModalOverlay) closePromptModal();
        });

        function setupPanelToggle(button, panel, checkbox, collapseIcon, expandIcon) {
            const toggle = (isOpen) => {
                const isCollapsed = !isOpen;
                panel.classList.toggle('collapsed', isCollapsed);
                if (collapseIcon) collapseIcon.classList.toggle('hidden', isCollapsed);
                if (expandIcon) expandIcon.classList.toggle('hidden', !isCollapsed);
                if (checkbox) checkbox.checked = isOpen;
            };

            button.addEventListener('click', () => toggle(panel.classList.contains('collapsed')));
            if (checkbox) {
                checkbox.addEventListener('change', () => toggle(checkbox.checked));
            }
        }

        windowMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            windowDropdownMenu.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
            if (!windowDropdownMenu.contains(e.target) && e.target !== windowMenuButton) {
                windowDropdownMenu.classList.remove('open');
            }
        });

        infoButton.addEventListener('click', () => {
            infoModalOverlay.classList.remove('hidden', 'opacity-0');
            infoModalContent.classList.remove('scale-95', 'opacity-0');
        });
        infoModalClose.addEventListener('click', () => {
            infoModalOverlay.classList.add('opacity-0');
            infoModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => infoModalOverlay.classList.add('hidden'), 300);
        });
        infoModalOverlay.addEventListener('click', (e) => {
            if (e.target === infoModalOverlay) {
                infoModalClose.click();
            }
        });

        function closeConfigModal() {
            configModalOverlay.classList.add('opacity-0');
            configModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => configModalOverlay.classList.add('hidden'), 300);
        }
        
        function getCurrentCoreConfig() {
            const formData = new FormData(configForm);
            return Object.fromEntries(formData.entries());
        }

        function updateConfigButtonState() {
            const isConnected = teradataStatusDot.classList.contains('connected');
            
            if (!isConnected) {
                configActionButtonText.textContent = 'Connect & Load';
                configActionButton.type = 'submit';
                configActionButton.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                configActionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                configActionButton.onclick = null;
                return;
            }

            const currentConfig = getCurrentCoreConfig();
            const hasChanged = JSON.stringify(currentConfig) !== JSON.stringify(pristineConfig);
            
            if (hasChanged) {
                configActionButtonText.textContent = 'Reconnect & Load';
                configActionButton.type = 'submit';
                configActionButton.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                configActionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                configActionButton.onclick = null;
            } else {
                configActionButtonText.textContent = 'Close';
                configActionButton.type = 'button';
                configActionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                configActionButton.classList.add('bg-gray-600', 'hover:bg-gray-500');
                configActionButton.onclick = closeConfigModal;
            }
        }

        configMenuButton.addEventListener('click', () => {
            configModalOverlay.classList.remove('hidden', 'opacity-0');
            configModalContent.classList.remove('scale-95', 'opacity-0');
            
            pristineConfig = getCurrentCoreConfig();
            updateConfigButtonState();
        });
        
        configModalClose.addEventListener('click', () => {
            const coreChanged = JSON.stringify(getCurrentCoreConfig()) !== JSON.stringify(pristineConfig);
            if (coreChanged) {
                showConfirmation('Discard Changes?', 'You have unsaved changes in your configuration. Are you sure you want to close?', closeConfigModal);
            } else {
                closeConfigModal();
            }
        });
        
        function startPopupCountdown() {
            if (systemPromptPopupTimer) {
                clearInterval(systemPromptPopupTimer);
            }

            const countdownTimerEl = document.getElementById('countdown-timer');
            const countdownContainerEl = document.getElementById('countdown-container');

            if (countdownTimerEl && countdownContainerEl) {
                countdownTimerEl.textContent = countdownValue;
                countdownContainerEl.style.visibility = 'visible';

                systemPromptPopupTimer = setInterval(() => {
                    countdownValue--;
                    countdownTimerEl.textContent = countdownValue;
                    if (countdownValue <= 0) {
                        closeSystemPromptPopup();
                    }
                }, 1000);
            }
        }

        function stopPopupCountdown() {
            if (systemPromptPopupTimer) {
                clearInterval(systemPromptPopupTimer);
                systemPromptPopupTimer = null;
            }
            const countdownContainerEl = document.getElementById('countdown-container');
            if(countdownContainerEl) {
                countdownContainerEl.style.visibility = 'hidden';
            }
        }

        function openSystemPromptPopup() {
            const promptText = getSystemPromptForModel(currentProvider, currentModel);
            const isCustom = isPromptCustomForModel(currentProvider, currentModel);
            
            if (isCustom) {
                systemPromptPopupTitle.innerHTML = `Custom System Prompt for: <code class="text-teradata-orange font-normal">${currentProvider} / ${getNormalizedModelId(currentModel)}</code>`;
            } else {
                systemPromptPopupTitle.innerHTML = `Default System Prompt Selected for: <code class="text-teradata-orange font-normal">${currentProvider}</code>`;
            }

            systemPromptPopupText.textContent = promptText || "Could not load system prompt.";
            systemPromptPopupOverlay.classList.remove('hidden', 'opacity-0');
            systemPromptPopupContent.classList.remove('scale-95', 'opacity-0');
            
            countdownValue = 5;
            startPopupCountdown();
            
            mouseMoveHandler = () => {
                stopPopupCountdown();
                document.removeEventListener('mousemove', mouseMoveHandler);
            };
            document.addEventListener('mousemove', mouseMoveHandler);
        }

        function closeSystemPromptPopup() {
            stopPopupCountdown();
            if (mouseMoveHandler) {
                 document.removeEventListener('mousemove', mouseMoveHandler);
                 mouseMoveHandler = null;
            }
            systemPromptPopupOverlay.classList.add('opacity-0');
            systemPromptPopupContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                systemPromptPopupOverlay.classList.add('hidden');
            }, 300);
        }

        systemPromptPopupClose.addEventListener('click', closeSystemPromptPopup);
        systemPromptPopupOverlay.addEventListener('click', (e) => {
            if (e.target === systemPromptPopupOverlay) closeSystemPromptPopup();
        });

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedModel = llmModelSelect.value;
            if (!selectedModel) {
                configStatus.textContent = 'Please select your LLM Model.';
                configStatus.className = 'text-sm text-red-400 text-center';
                return;
            }

            configLoadingSpinner.classList.remove('hidden');
            configActionButton.disabled = true;
            configStatus.textContent = 'Connecting to Teradata & LLM...';
            configStatus.className = 'text-sm text-yellow-400 text-center';

            const formData = new FormData(e.target);
            const config = Object.fromEntries(formData.entries());
            
            const mcpConfig = { host: config.host, port: config.port, path: config.path };
            localStorage.setItem('mcpConfig', JSON.stringify(mcpConfig));
            
            if (config.provider === 'Amazon') {
                const awsCreds = { aws_access_key_id: config.aws_access_key_id, aws_secret_access_key: config.aws_secret_access_key, aws_region: config.aws_region };
                localStorage.setItem('amazonApiKey', JSON.stringify(awsCreds));
            } else if (config.provider === 'Ollama') {
                localStorage.setItem('ollamaHost', config.ollama_host);
            } else {
                localStorage.setItem(`${config.provider.toLowerCase()}ApiKey`, config.apiKey);
            }

            try {
                const res = await fetch('/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await res.json();

                if (res.ok) {
                    configStatus.textContent = 'Success! Teradata & LLM services connected.';
                    configStatus.className = 'text-sm text-green-400 text-center';
                    teradataStatusDot.classList.remove('disconnected');
                    teradataStatusDot.classList.add('connected');
                    llmStatusDot.classList.remove('disconnected', 'busy');
                    llmStatusDot.classList.add('connected');
                    
                    localStorage.setItem('lastSelectedProvider', config.provider);
                    
                    currentProvider = config.provider;
                    currentModel = config.model;
                    
                    const activePrompt = getSystemPromptForModel(currentProvider, currentModel);
                    if (!activePrompt) {
                        await resetSystemPrompt(true);
                    }

                    chatModalButton.disabled = false;
                    promptEditorButton.disabled = false;

                    await loadResources('tools');
                    await loadResources('prompts');
                    await loadResources('resources');
                    
                    userInput.placeholder = "Ask about databases, tables, users...";
                    
                    await startNewSession();
                    
                    pristineConfig = getCurrentCoreConfig();
                    
                    setTimeout(closeConfigModal, 1000);
                    
                    updateConfigButtonState();
                    openSystemPromptPopup();

                } else {
                    throw new Error(result.message || 'An unknown configuration error occurred.');
                }
            } catch (error) {
                configStatus.textContent = `Error: ${error.message}`;
                configStatus.className = 'text-sm text-red-400 text-center';
                promptEditorButton.disabled = true;
                chatModalButton.disabled = true;
                teradataStatusDot.classList.add('disconnected');
                teradataStatusDot.classList.remove('connected');
                llmStatusDot.classList.add('disconnected');
                llmStatusDot.classList.remove('connected', 'idle');
            } finally {
                configLoadingSpinner.classList.add('hidden');
                configActionButton.disabled = false;
                updateConfigButtonState();
            }
        });
        
        async function fetchModels() {
            const provider = llmProviderSelect.value;
            let body = { provider };

            if (provider === 'Amazon') {
                body.aws_access_key_id = awsAccessKeyIdInput.value;
                body.aws_secret_access_key = awsSecretAccessKeyInput.value;
                body.aws_region = awsRegionInput.value;
                body.listing_method = document.querySelector('input[name="listing_method"]:checked').value;
            } else if (provider === 'Ollama') {
                body.host = ollamaHostInput.value;
            } else {
                body.apiKey = llmApiKeyInput.value;
            }

            if (
                (provider === 'Amazon' && (!body.aws_access_key_id || !body.aws_secret_access_key || !body.aws_region)) ||
                (provider === 'Ollama' && !body.host) ||
                (!['Amazon', 'Ollama'].includes(provider) && !body.apiKey)
            ) {
                 configStatus.textContent = 'API credentials or host are required to fetch models.';
                configStatus.className = 'text-sm text-yellow-400 text-center';
                return;
            }

            refreshIcon.classList.add('hidden');
            refreshSpinner.classList.remove('hidden');
            refreshModelsButton.disabled = true;
            configStatus.textContent = 'Fetching models...';
            configStatus.className = 'text-sm text-gray-400 text-center';

            try {
                const response = await fetch('/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();

                if (response.ok) {
                    llmModelSelect.innerHTML = '';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name + (model.certified ? '' : ' (support evaluated)');
                        option.disabled = !model.certified;
                        llmModelSelect.appendChild(option);
                    });
                    configStatus.textContent = `Successfully fetched ${result.models.length} models.`;
                    configStatus.className = 'text-sm text-green-400 text-center';
                    
                    if (llmModelSelect.value) {
                        await handleModelChange();
                    }

                } else {
                    throw new Error(result.message || 'Failed to fetch models.');
                }
            } catch (error) {
                configStatus.textContent = `Error: ${error.message}`;
                configStatus.className = 'text-sm text-red-400 text-center';
                llmModelSelect.innerHTML = '<option value="">-- Could not fetch models --</option>';
            } finally {
                refreshIcon.classList.remove('hidden');
                refreshSpinner.classList.add('hidden');
                refreshModelsButton.disabled = false;
            }
        }
        
        async function handleModelChange() {
            currentModel = llmModelSelect.value;
            currentProvider = llmProviderSelect.value;
            if (!currentModel || !currentProvider) return;

            const activePrompt = getSystemPromptForModel(currentProvider, currentModel);
            if (!activePrompt) {
                configStatus.textContent = `Fetching default prompt for ${getNormalizedModelId(currentModel)}...`;
                configStatus.className = 'text-sm text-gray-400 text-center';
                await resetSystemPrompt(true); 
                configStatus.textContent = `Default prompt for ${getNormalizedModelId(currentModel)} loaded.`;
                setTimeout(() => { configStatus.textContent = ''; }, 2000);
            }
        }

        llmProviderSelect.addEventListener('change', async () => {
            const newProvider = llmProviderSelect.value;
            
            apiKeyContainer.classList.add('hidden');
            awsCredentialsContainer.classList.add('hidden');
            awsListingMethodContainer.classList.add('hidden');
            ollamaHostContainer.classList.add('hidden');

            if (newProvider === 'Amazon') {
                awsCredentialsContainer.classList.remove('hidden');
                awsListingMethodContainer.classList.remove('hidden');
                
                const res = await fetch('/api_key/amazon');
                const envCreds = await res.json();
                const savedCreds = JSON.parse(localStorage.getItem('amazonApiKey')) || {};
                
                awsAccessKeyIdInput.value = envCreds.aws_access_key_id || savedCreds.aws_access_key_id || '';
                awsSecretAccessKeyInput.value = envCreds.aws_secret_access_key || savedCreds.aws_secret_access_key || '';
                awsRegionInput.value = envCreds.aws_region || savedCreds.aws_region || '';

            } else if (newProvider === 'Ollama') {
                ollamaHostContainer.classList.remove('hidden');
                const res = await fetch('/api_key/ollama');
                const data = await res.json();
                ollamaHostInput.value = data.host || localStorage.getItem('ollamaHost') || 'http://localhost:11434';
            } else { 
                apiKeyContainer.classList.remove('hidden');
                const res = await fetch(`/api_key/${newProvider.toLowerCase()}`);
                const data = await res.json();
                llmApiKeyInput.value = data.apiKey || localStorage.getItem(`${newProvider.toLowerCase()}ApiKey`) || '';
            }
            llmModelSelect.innerHTML = '<option value="">-- Select Provider & Enter Credentials --</option>';
            configStatus.textContent = '';
        });

        [awsAccessKeyIdInput, awsSecretAccessKeyInput, awsRegionInput].forEach(input => {
            input.addEventListener('blur', () => {
                const awsCreds = {
                    aws_access_key_id: awsAccessKeyIdInput.value,
                    aws_secret_access_key: awsSecretAccessKeyInput.value,
                    aws_region: awsRegionInput.value
                };
                localStorage.setItem('amazonApiKey', JSON.stringify(awsCreds));
            });
        });

        llmApiKeyInput.addEventListener('blur', () => {
            const provider = llmProviderSelect.value;
            const apiKey = llmApiKeyInput.value;
            if (apiKey && !['Amazon', 'Ollama'].includes(provider)) {
                localStorage.setItem(`${provider.toLowerCase()}ApiKey`, apiKey);
            }
        });
        
        ollamaHostInput.addEventListener('blur', () => {
            localStorage.setItem('ollamaHost', ollamaHostInput.value);
        });


        refreshModelsButton.addEventListener('click', fetchModels);

        function openPromptEditor() {
            promptEditorTitle.innerHTML = `System Prompt Editor for: <code class="text-teradata-orange font-normal">${currentProvider} / ${getNormalizedModelId(currentModel)}</code>`;
            promptEditorTextarea.value = getSystemPromptForModel(currentProvider, currentModel);
            promptEditorOverlay.classList.remove('hidden', 'opacity-0');
            promptEditorContent.classList.remove('scale-95', 'opacity-0');
        }

        function closePromptEditor() {
            promptEditorOverlay.classList.add('opacity-0');
            promptEditorContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => promptEditorOverlay.classList.add('hidden'), 300);
        }

        async function saveSystemPromptChanges() {
            const newPromptText = promptEditorTextarea.value;
            const defaultPromptText = await getDefaultSystemPrompt(currentProvider, currentModel);

            if (defaultPromptText === null) {
                return;
            }

            const isCustom = newPromptText.trim() !== defaultPromptText.trim();
            
            saveSystemPromptForModel(currentProvider, currentModel, newPromptText, isCustom);
            updateStatusPromptName();
            
            promptEditorStatus.textContent = 'Saved!';
            promptEditorStatus.className = 'text-sm text-green-400';
            setTimeout(() => { promptEditorStatus.textContent = ''; }, 2000);
        }

        async function resetSystemPrompt(force = false) {
            const defaultPrompt = await getDefaultSystemPrompt(currentProvider, currentModel);
            if (defaultPrompt) {
                saveSystemPromptForModel(currentProvider, currentModel, defaultPrompt, false);
                promptEditorTextarea.value = defaultPrompt;
                updateStatusPromptName();
                if (!force) {
                    promptEditorStatus.textContent = 'Reset to default and saved!';
                    promptEditorStatus.className = 'text-sm text-yellow-400';
                    setTimeout(() => { promptEditorStatus.textContent = ''; }, 2000);
                }
            }
        }
        
        function showConfirmation(title, body, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalBody.textContent = body;
            
            confirmModalOverlay.classList.remove('hidden', 'opacity-0');
            confirmModalContent.classList.remove('scale-95', 'opacity-0');

            const confirmHandler = () => {
                onConfirm();
                closeConfirmation();
            };

            const cancelHandler = () => {
                closeConfirmation();
            };
            
            const closeConfirmation = () => {
                confirmModalOverlay.classList.add('opacity-0');
                confirmModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => confirmModalOverlay.classList.add('hidden'), 300);
                confirmModalConfirm.removeEventListener('click', confirmHandler);
                confirmModalCancel.removeEventListener('click', cancelHandler);
            };

            confirmModalConfirm.addEventListener('click', confirmHandler, { once: true });
            confirmModalCancel.addEventListener('click', cancelHandler, { once: true });
        }
        
        async function handleIntensityChange() {
             if (isPromptCustomForModel(currentProvider, currentModel)) {
                showConfirmation(
                    'Reset System Prompt?',
                    'Changing the charting intensity requires resetting the system prompt to a new default to include updated instructions. Your custom changes will be lost. Do you want to continue?',
                    () => {
                        resetSystemPrompt(true);
                        configStatus.textContent = 'Charting intensity updated and system prompt was reset to default.';
                        configStatus.className = 'text-sm text-yellow-400 text-center';
                    }
                );
            } else {
                await resetSystemPrompt(true);
                configStatus.textContent = 'Charting intensity updated.';
                configStatus.className = 'text-sm text-green-400 text-center';
            }
        }

        chartingIntensitySelect.addEventListener('change', handleIntensityChange);

        promptEditorButton.addEventListener('click', openPromptEditor);
        promptEditorClose.addEventListener('click', closePromptEditor);
        promptEditorSave.addEventListener('click', saveSystemPromptChanges);
        promptEditorReset.addEventListener('click', () => resetSystemPrompt(false));

        function openChatModal() {
            chatModalOverlay.classList.remove('hidden', 'opacity-0');
            chatModalContent.classList.remove('scale-95', 'opacity-0');
            chatModalInput.focus();
        }

        function closeChatModal() {
            chatModalOverlay.classList.add('opacity-0');
            chatModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => chatModalOverlay.classList.add('hidden'), 300);
        }

        function addMessageToModal(role, content) {
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 rounded-lg max-w-xs ${role === 'user' ? 'bg-blue-600 self-end' : 'bg-gray-600 self-start'}`;
            messageEl.textContent = content;
            chatModalLog.appendChild(messageEl);
            chatModalLog.scrollTop = chatModalLog.scrollHeight;
        }

        chatModalButton.addEventListener('click', openChatModal);
        chatModalClose.addEventListener('click', closeChatModal);
        chatModalOverlay.addEventListener('click', (e) => {
            if (e.target === chatModalOverlay) closeChatModal();
        });

        chatModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatModalInput.value.trim();
            if (!message) return;

            addMessageToModal('user', message);
            simpleChatHistory.push({ role: 'user', content: message });
            chatModalInput.value = '';
            chatModalInput.disabled = true;

            try {
                const res = await fetch('/simple_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: simpleChatHistory
                    })
                });
                
                const data = await res.json();

                if (res.ok) {
                    addMessageToModal('assistant', data.response);
                    simpleChatHistory.push({ role: 'assistant', content: data.response });
                } else {
                    throw new Error(data.error || 'An unknown error occurred.');
                }

            } catch (error) {
                addMessageToModal('assistant', `Error: ${error.message}`);
            } finally {
                chatModalInput.disabled = false;
                chatModalInput.focus();
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/app-config');
                const appConfig = await res.json();
                
                const chartingIntensityContainer = document.getElementById('charting-intensity-container');
                if (!appConfig.charting_enabled) {
                    chartingIntensityContainer.style.display = 'none';
                }

            } catch (e) {
                console.error("Could not fetch app config", e);
            }

            const savedMcpConfig = JSON.parse(localStorage.getItem('mcpConfig'));
            if (savedMcpConfig) {
                document.getElementById('mcp-host').value = savedMcpConfig.host || '127.0.0.1';
                document.getElementById('mcp-port').value = savedMcpConfig.port || '8001';
                document.getElementById('mcp-path').value = savedMcpConfig.path || '/mcp/';
            } else {
                 document.getElementById('mcp-host').value = '127.0.0.1';
                document.getElementById('mcp-port').value = '8001';
                document.getElementById('mcp-path').value = '/mcp/';
            }
            
            const lastProvider = localStorage.getItem('lastSelectedProvider');
            if (lastProvider) {
                llmProviderSelect.value = lastProvider;
            }
            llmProviderSelect.dispatchEvent(new Event('change'));

            toggleHistoryCheckbox.checked = !sessionHistoryPanel.classList.contains('collapsed');
            setupPanelToggle(toggleHistoryButton, sessionHistoryPanel, toggleHistoryCheckbox, historyCollapseIcon, historyExpandIcon);

            toggleHeaderCheckbox.checked = !toolHeader.classList.contains('collapsed');
            setupPanelToggle(toggleHeaderButton, toolHeader, toggleHeaderCheckbox, headerCollapseIcon, headerExpandIcon);

            toggleStatusCheckbox.checked = !statusWindow.classList.contains('collapsed');
            setupPanelToggle(toggleStatusButton, statusWindow, toggleStatusCheckbox, statusCollapseIcon, statusExpandIcon);
            
            configMenuButton.click();

            if (llmApiKeyInput.value || awsAccessKeyIdInput.value || ollamaHostInput.value) {
                await fetchModels();
            }
            
            configForm.addEventListener('input', updateConfigButtonState);
        });
    </script>
</body>
</html>
